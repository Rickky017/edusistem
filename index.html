<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Calificaciones</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .hidden {
            display: none;
        }
        .tab-button.active {
            background-color: #3b82f6;
            color: white;
            box-shadow: 0 4px 6px rgba(59, 130, 246, 0.25);
        }
        .tab-button:not(.active) {
            background-color: transparent;
            color: #6b7280;
        }
        .tab-button:hover {
            background-color: #e5e7eb;
        }
        .report-section {
            border-left: 4px solid #3b82f6;
            padding-left: 1rem;
        }
        .text-error {
            color: #ef4444;
        }
        .grade-card-fail {
            background-color: #fef2f2;
            border-color: #fca5a5;
        }
        .grade-card-pass {
            background-color: #f0fdf4;
            border-color: #a7f3d0;
        }
        .period-step {
            transition: all 0.3s ease-in-out;
            transform: scale(1);
            filter: grayscale(80%);
            opacity: 0.6;
            font-weight: 500;
        }
        .period-step.active {
            filter: grayscale(0%);
            transform: scale(1.1);
            opacity: 1;
            font-weight: 800;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .grade-card-container {
            position: relative;
        }
        .grade-actions {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: none;
            gap: 8px;
        }
        .grade-card-container:hover .grade-actions {
            display: flex;
        }
        .period-separator {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            font-weight: bold;
            color: #9ca3af;
            cursor: default;
        }
        .period-separator::before {
            content: '';
            flex: 1;
            height: 1px;
            background-color: #d1d5db;
            margin-right: 10px;
        }
        .period-separator::after {
            content: '';
            flex: 1;
            height: 1px;
            background-color: #d1d5db;
            margin-left: 10px;
        }
    </style>
</head>
<body class="p-6 sm:p-8 md:p-12">
    <!-- Header -->
    <div class="bg-white rounded-xl shadow-lg p-6 sm:p-8 mb-6">
        <h1 class="text-3xl sm:text-4xl font-bold text-gray-800 mb-2 text-center">Gestión de Calificaciones</h1>
        <p class="text-gray-500 text-center">Administra tus estudiantes, grupos, asistencia y calificaciones de forma sencilla.</p>
    </div>

    <!-- Tab Navigation -->
    <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-4 mb-6">
        <button id="tab-gestion-btn" onclick="activateTab('gestion')" class="tab-button w-full sm:w-1/2 md:w-1/4 py-3 px-6 rounded-lg font-medium text-lg transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">Gestión</button>
        <button id="tab-asistencia-btn" onclick="activateTab('asistencia')" class="tab-button w-full sm:w-1/2 md:w-1/4 py-3 px-6 rounded-lg font-medium text-lg transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">Asistencia</button>
        <button id="tab-calificaciones-btn" onclick="activateTab('calificaciones')" class="tab-button w-full sm:w-1/2 md:w-1/4 py-3 px-6 rounded-lg font-medium text-lg transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">Calificaciones</button>
        <button id="tab-anecdotico-btn" onclick="activateTab('anecdotico')" class="tab-button w-full sm:w-1/2 md:w-1/4 py-3 px-6 rounded-lg font-medium text-lg transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">Registro Anecdótico</button>
    </div>

    <!-- Main Content -->
    <div class="bg-white rounded-xl shadow-lg p-6 sm:p-8">
        <!-- Gestión Tab Content -->
        <div id="gestion-tab" class="tab-content">
            <h2 class="text-2xl sm:text-3xl font-bold text-gray-800 mb-4">Gestión de Estudiantes y Grupos</h2>

            <!-- Gestión de Grupos -->
            <div class="mb-8 p-6 bg-gray-50 rounded-xl shadow-inner">
                <h3 class="text-xl font-semibold text-gray-700 mb-4 flex items-center">
                    Gestión de Grupos
                    <span id="group-error" class="ml-4 text-sm font-normal text-red-500 hidden"></span>
                </h3>
                <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4">
                    <input type="text" id="new-group-name" placeholder="Nombre del nuevo grupo" class="flex-grow px-4 py-2 border rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <button onclick="addGroup()" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-6 rounded-full transition-colors duration-200 shadow-md">Crear Grupo</button>
                </div>
                <div class="mt-4">
                    <ul id="groups-list" class="space-y-2">
                        <!-- Group items will be populated here -->
                    </ul>
                </div>
            </div>

            <!-- Gestión de Estudiantes -->
            <div class="p-6 bg-gray-50 rounded-xl shadow-inner">
                <h3 class="text-xl font-semibold text-gray-700 mb-4 flex items-center">
                    Gestión de Estudiantes
                    <span id="student-error" class="ml-4 text-sm font-normal text-red-500 hidden"></span>
                </h3>
                <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4 mb-4">
                    <textarea id="student-names-input" placeholder="Nombres de estudiantes (uno por línea)" class="flex-grow px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                    <select id="student-group-select" class="flex-grow px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <!-- Student groups will be populated here -->
                    </select>
                    <button onclick="addStudentsInBulk()" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-6 rounded-full transition-colors duration-200 shadow-md">Añadir Estudiantes</button>
                </div>
                <div id="students-grouped-list" class="space-y-4">
                    <!-- Student items grouped by group will be populated here -->
                </div>
            </div>
        </div>

        <!-- Asistencia Tab Content -->
        <div id="asistencia-tab" class="tab-content hidden">
            <h2 class="text-2xl sm:text-3xl font-bold text-gray-800 mb-4">Registro de Asistencia</h2>
            <p class="text-gray-500 mb-4">Selecciona los estudiantes para marcar su asistencia.</p>
            <div class="mb-4 flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4">
                <div class="flex-1">
                    <label for="group-filter-select" class="block text-gray-700 font-medium mb-1">Filtrar por Grupo:</label>
                    <select id="group-filter-select" onchange="filterAttendanceByGroup()" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Todos los Grupos</option>
                    </select>
                </div>
                <div class="flex-1">
                    <label for="attendance-date" class="block text-gray-700 font-medium mb-1">Fecha de Asistencia:</label>
                    <input type="date" id="attendance-date" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
            </div>
            <div id="attendance-section" class="space-y-4">
                <div id="attendance-list" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
                    <!-- Attendance cards will be populated here -->
                </div>
                <button onclick="saveAttendance()" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 rounded-full transition-colors duration-200 shadow-md">Guardar Asistencia</button>
                <button onclick="generateReport()" class="w-full bg-gray-400 hover:bg-gray-500 text-white font-semibold py-3 rounded-full transition-colors duration-200 shadow-md">Generar Reporte Mensual</button>
            </div>
            <div id="report-section" class="hidden mt-8">
                <h3 class="text-2xl font-bold mb-4">Reporte Mensual</h3>
                <div id="report-output" class="bg-gray-50 p-6 rounded-lg overflow-x-auto">
                    <!-- Report content will be populated here -->
                </div>
            </div>
        </div>

        <!-- Calificaciones Tab Content -->
        <div id="calificaciones-tab" class="tab-content hidden">
            <h2 class="text-2xl sm:text-3xl font-bold text-gray-800 mb-4">Gestión de Calificaciones</h2>
            <p class="text-gray-500 mb-4">Añade o visualiza las calificaciones de tus estudiantes.</p>
            
            <div class="mb-6 p-6 bg-gray-50 rounded-xl shadow-inner">
                <h3 class="text-xl font-semibold text-gray-700 mb-4">Añadir Calificación</h3>

                <div class="mb-4">
                    <label for="period-pattern-input" class="block text-gray-700 font-medium mb-1">Personalizar Patrón de Periodos (ej: P1,P2,RP,P3,P4,RP)</label>
                    <input type="text" id="period-pattern-input" class="w-full px-4 py-2 border rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500" value="P1,P2,RP,P3,P4,RP,P1,P2,RP,P3,P4,RP,P1,P2,RP,P3,P4,RP,P1,P2,RP,P3,P4,RP">
                </div>
                
                <!-- Visualizador del patrón de periodos -->
                <div class="flex items-center justify-center space-x-2 sm:space-x-4 mb-6">
                    <span class="text-gray-500 font-medium hidden sm:block">Siguiente:</span>
                    <div id="pattern-display" class="flex flex-wrap justify-center gap-2">
                        <!-- Los pasos del patrón se agregarán dinámicamente aquí -->
                    </div>
                </div>

                <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4 mb-4">
                    <select id="student-grade-select" onchange="updatePeriodDisplay()" class="flex-grow px-4 py-2 border rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Seleccionar estudiante</option>
                    </select>
                    <select id="period-select" class="flex-grow px-4 py-2 border rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Seleccionar Periodo</option>
                    </select>
                    <input type="number" id="grade-input" placeholder="Calificación (0-100)" min="0" max="100" class="flex-grow px-4 py-2 border rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>

                <!-- Nuevos campos para la nota -->
                <div class="mb-4">
                    <label for="grade-reason-select" class="block text-gray-700 font-medium mb-1">Razón de la calificación:</label>
                    <select id="grade-reason-select" class="w-full px-4 py-2 border rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Seleccionar una razón (opcional)</option>
                        <option value="No entregó">No entregó</option>
                        <option value="Entrega incompleta">Entrega incompleta</option>
                        <option value="Entrega tardía">Entrega tardía</option>
                        <option value="Entrega a tiempo">Entrega a tiempo</option>
                        <option value="Buen trabajo">Buen trabajo</option>
                        <option value="Excelente participación en clase">Excelente participación en clase</option>
                        <option value="Debe mejorar el esfuerzo">Debe mejorar el esfuerzo</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label for="grade-note-input" class="block text-gray-700 font-medium mb-1">Nota adicional:</label>
                    <textarea id="grade-note-input" placeholder="Escribe un comentario adicional (opcional)" rows="2" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                </div>
                
                <button onclick="addGrade()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-6 rounded-full transition-colors duration-200 shadow-md">Guardar Calificación</button>
            </div>

            <div class="p-6 bg-gray-50 rounded-xl shadow-inner">
                <h3 class="text-xl font-semibold text-gray-700 mb-4">Historial de Calificaciones</h3>
                <ul id="grades-list" class="space-y-2">
                    <!-- Grades will be populated here -->
                </ul>
            </div>
        </div>

        <!-- Anecdótico Tab Content -->
        <div id="anecdotico-tab" class="tab-content hidden">
            <h2 class="text-2xl sm:text-3xl font-bold text-gray-800 mb-4">Registro Anecdótico</h2>
            <p class="text-gray-500 mb-4">Documenta observaciones y notas de cada estudiante.</p>

            <div class="mb-6 p-6 bg-gray-50 rounded-xl shadow-inner">
                <h3 class="text-xl font-semibold text-gray-700 mb-4">Añadir Nota</h3>
                <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4 mb-4">
                    <select id="student-anecdote-select" class="flex-grow px-4 py-2 border rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Seleccionar estudiante</option>
                    </select>
                    <input type="date" id="anecdote-date-input" class="px-4 py-2 border rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <textarea id="anecdote-note-input" placeholder="Escribe tu nota aquí..." rows="4" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 mb-4"></textarea>
                <button onclick="addAnecdote()" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-6 rounded-full transition-colors duration-200 shadow-md">Guardar Nota</button>
            </div>

            <div class="p-6 bg-gray-50 rounded-xl shadow-inner">
                <h3 class="text-xl font-semibold text-gray-700 mb-4">Historial de Notas</h3>
                <div id="anecdotes-list" class="space-y-4">
                    <!-- Anecdotes will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Errores y Mensajes -->
    <div id="modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-xl shadow-xl p-6 w-full max-w-sm">
            <h4 id="modal-title" class="text-xl font-bold mb-4"></h4>
            <p id="modal-message" class="text-gray-700 mb-6"></p>
            <div class="flex justify-end">
                <button onclick="closeModal()" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-full">Cerrar</button>
            </div>
        </div>
    </div>
    
    <!-- Modal de Confirmación -->
    <div id="confirm-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-xl shadow-xl p-6 w-full max-w-sm">
            <h4 id="confirm-modal-title" class="text-xl font-bold mb-4">Confirmar Acción</h4>
            <p id="confirm-modal-message" class="text-gray-700 mb-6"></p>
            <div class="flex justify-end space-x-4">
                <button onclick="cancelAction()" class="bg-gray-400 hover:bg-gray-500 text-white font-semibold py-2 px-4 rounded-full">Cancelar</button>
                <button onclick="executeAction()" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-full">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Edición de Calificación -->
    <div id="edit-grade-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-xl shadow-xl p-6 w-full max-w-sm">
            <h4 class="text-xl font-bold mb-4">Editar Calificación</h4>
            <input type="hidden" id="edit-grade-id">
            <div class="mb-4">
                <label for="edit-grade-input" class="block text-gray-700 font-medium mb-2">Nueva Calificación:</label>
                <input type="number" id="edit-grade-input" placeholder="0-100" min="0" max="100" class="w-full px-4 py-2 border rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div class="mb-4">
                <label for="edit-grade-reason-select" class="block text-gray-700 font-medium mb-1">Razón de la calificación:</label>
                <select id="edit-grade-reason-select" class="w-full px-4 py-2 border rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">Seleccionar una razón (opcional)</option>
                    <option value="No entregó">No entregó</option>
                    <option value="Entrega incompleta">Entrega incompleta</option>
                    <option value="Entrega tardía">Entrega tardía</option>
                    <option value="Entrega a tiempo">Entrega a tiempo</option>
                    <option value="Buen trabajo">Buen trabajo</option>
                    <option value="Excelente participación en clase">Excelente participación en clase</option>
                    <option value="Debe mejorar el esfuerzo">Debe mejorar el esfuerzo</option>
                </select>
            </div>
            <div class="mb-4">
                <label for="edit-grade-note-input" class="block text-gray-700 font-medium mb-1">Nota adicional:</label>
                <textarea id="edit-grade-note-input" placeholder="Escribe un comentario adicional (opcional)" rows="2" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
            </div>
            <div class="flex justify-end space-x-4">
                <button onclick="document.getElementById('edit-grade-modal').classList.add('hidden')" class="bg-gray-400 hover:bg-gray-500 text-white font-semibold py-2 px-4 rounded-full">Cancelar</button>
                <button onclick="saveEditedGrade()" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-full">Guardar</button>
            </div>
        </div>
    </div>
    
    <!-- Modal de Calificación Final -->
    <div id="final-grade-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-xl shadow-xl p-6 w-full max-w-lg">
            <h4 class="text-2xl font-bold mb-4 text-center">Calificación Final</h4>
            <div id="final-grade-content"></div>
            <div class="flex justify-end mt-6">
                <button onclick="document.getElementById('final-grade-modal').classList.add('hidden')" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-full">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Nota de Calificación -->
    <div id="view-grade-note-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-xl shadow-xl p-6 w-full max-w-sm">
            <h4 class="text-xl font-bold mb-4" id="view-grade-note-title">Nota de Calificación</h4>
            <div class="text-gray-700 space-y-2">
                <p><strong>Estudiante:</strong> <span id="view-grade-note-student"></span></p>
                <p><strong>Período:</strong> <span id="view-grade-note-period"></span></p>
                <p><strong>Calificación:</strong> <span id="view-grade-note-grade"></span></p>
                <p><strong>Razón:</strong> <span id="view-grade-note-reason"></span></p>
                <p><strong>Comentario:</strong></p>
                <div class="bg-gray-100 p-3 rounded-lg"><p class="whitespace-pre-wrap" id="view-grade-note-comment"></p></div>
            </div>
            <div class="flex justify-end mt-6">
                <button onclick="document.getElementById('view-grade-note-modal').classList.add('hidden')" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-full">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Edición de Anecdota -->
    <div id="edit-anecdote-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-xl shadow-xl p-6 w-full max-w-sm">
            <h4 class="text-xl font-bold mb-4">Editar Nota Anecdótica</h4>
            <input type="hidden" id="edit-anecdote-id">
            <div class="mb-4">
                <label for="edit-anecdote-note-input" class="block text-gray-700 font-medium mb-2">Nueva Nota:</label>
                <textarea id="edit-anecdote-note-input" rows="4" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
            </div>
            <div class="flex justify-end space-x-4">
                <button onclick="document.getElementById('edit-anecdote-modal').classList.add('hidden')" class="bg-gray-400 hover:bg-gray-500 text-white font-semibold py-2 px-4 rounded-full">Cancelar</button>
                <button onclick="saveEditedAnecdote()" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-full">Guardar</button>
            </div>
        </div>
    </div>

<script type="module">
// Importa las funciones que necesitas del SDK
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-analytics.js";
  // Puedes agregar más imports según los productos de Firebase que uses

  // Tu configuración de Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyBsTK0Ax5tzjX4mz25n4hoGVotIuUkKrFo",
    authDomain: "edusistem-eef5e.firebaseapp.com",
    projectId: "edusistem-eef5e",
    storageBucket: "edusistem-eef5e.appspot.com", // <--- corregido
    messagingSenderId: "328823083464",
    appId: "1:328823083464:web:0481e90cab31664474b0fd",
    measurementId: "G-K9KKDY141H"
  };

  // Inicializa Firebase
  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);

  // Puedes seguir agregando lógica aquí para otros servicios como Firestore, Auth, etc.

    setLogLevel('debug'); // Habilita logs de debug de Firestore

    let db;
    let auth;
    let userId;
    let groups = [];
    let students = [];
    let attendance = {};
    let grades = [];
    let anecdotes = [];
    let pendingAction = null;
    let periodPattern = ['P1', 'P2', 'RP', 'P3', 'P4', 'RP', 'P1', 'P2', 'RP', 'P3', 'P4', 'RP', 'P1', 'P2', 'RP', 'P3', 'P4', 'RP', 'P1', 'P2', 'RP', 'P3', 'P4', 'RP'];

    // Obtener variables globales del entorno
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
    
    // --- FIREBASE INITIALIZATION ---
    async function initializeFirebase() {
        if (Object.keys(firebaseConfig).length === 0) {
            console.error("Firebase config is missing. The app will not be able to save data.");
            showModal("Error de Configuración", "La configuración de Firebase no está disponible. No se podrán guardar los datos.");
            return;
        }
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            // Authentication with provided token or anonymously
            if (initialAuthToken) {
                await signInWithCustomToken(auth, initialAuthToken);
            } else {
                await signInAnonymously(auth);
            }
            console.log("Firebase initialized successfully.");

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    console.log("User authenticated:", userId);
                    startDataListeners();
                    loadDailyAttendance();
                } else {
                    console.log("No user is authenticated.");
                    userId = crypto.randomUUID(); // Fallback to a random ID
                    loadDataOnce();
                }
            });

        } catch (error) {
            console.error("Error initializing Firebase:", error);
            showModal("Error de Firebase", "No se pudo conectar a la base de datos.");
        }
    }

    async function loadDataOnce() {
        console.log("Loading data without real-time listeners.");
        const studentsCollection = collection(db, 'artifacts', appId, 'users', userId, 'students');
        const groupsCollection = collection(db, 'artifacts', appId, 'users', userId, 'groups');
        const attendanceCollection = collection(db, 'artifacts', appId, 'users', userId, 'attendance');
        const gradesCollection = collection(db, 'artifacts', appId, 'users', userId, 'grades');
        const anecdotesCollection = collection(db, 'artifacts', appId, 'users', userId, 'anecdotes');

        const studentsSnapshot = await getDocs(studentsCollection);
        students = studentsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        const groupsSnapshot = await getDocs(groupsCollection);
        groups = groupsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        const attendanceSnapshot = await getDocs(attendanceCollection);
        attendance = {};
        attendanceSnapshot.docs.forEach(doc => {
            attendance[doc.id] = doc.data();
        });

        const gradesSnapshot = await getDocs(gradesCollection);
        grades = gradesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        const anecdotesSnapshot = await getDocs(anecdotesCollection);
        anecdotes = anecdotesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        updateUI();
        loadDailyAttendance();
    }

    function startDataListeners() {
        console.log("Starting real-time listeners...");
        // Students listener
        const studentsCollectionRef = collection(db, 'artifacts', appId, 'users', userId, 'students');
        onSnapshot(studentsCollectionRef, (snapshot) => {
            students = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            updateUI();
            loadDailyAttendance();
        }, (error) => {
            console.error("Error with students listener:", error);
        });

        // Groups listener
        const groupsCollectionRef = collection(db, 'artifacts', appId, 'users', userId, 'groups');
        onSnapshot(groupsCollectionRef, (snapshot) => {
            groups = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            updateUI();
            renderGroupFilter();
            renderStudentGroupSelect();
        }, (error) => {
            console.error("Error with groups listener:", error);
        });

        // Attendance listener
        const attendanceCollectionRef = collection(db, 'artifacts', appId, 'users', userId, 'attendance');
        onSnapshot(attendanceCollectionRef, (snapshot) => {
            const newAttendance = {};
            snapshot.docs.forEach(doc => {
                newAttendance[doc.id] = doc.data();
            });
            attendance = newAttendance;
            updateUI();
        }, (error) => {
            console.error("Error with attendance listener:", error);
        });

        // Grades listener
        const gradesCollectionRef = collection(db, 'artifacts', appId, 'users', userId, 'grades');
        onSnapshot(gradesCollectionRef, (snapshot) => {
            grades = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            updateUI();
            updatePeriodDisplay();
        }, (error) => {
            console.error("Error with grades listener:", error);
        });

        // Anecdotes listener
        const anecdotesCollectionRef = collection(db, 'artifacts', appId, 'users', userId, 'anecdotes');
        onSnapshot(anecdotesCollectionRef, (snapshot) => {
            anecdotes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            updateUI();
            renderAnecdotes();
        }, (error) => {
            console.error("Error with anecdotes listener:", error);
        });
    }

    // --- UI FUNCTIONS ---
    window.activateTab = function(tabId) {
        document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
        document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));

        document.getElementById(`${tabId}-tab`).classList.remove('hidden');
        document.getElementById(`tab-${tabId}-btn`).classList.add('active');

        if (tabId === 'asistencia') {
            renderGroupFilter();
            loadDailyAttendance();
        } else if (tabId === 'calificaciones') {
            renderStudentGradeSelect();
            renderGradesList();
            updatePeriodDisplay();
        } else if (tabId === 'anecdotico') {
            renderStudentAnecdoteSelect();
            renderAnecdotes();
        }
    }

    function updateUI() {
        renderGroups();
        renderStudentsByGroup();
        renderStudentGroupSelect();
        renderStudentGradeSelect();
        renderStudentAnecdoteSelect();
        renderAttendanceList();
        renderGradesList();
        renderAnecdotes();
    }

    window.showModal = function(title, message) {
        document.getElementById('modal-title').textContent = title;
        document.getElementById('modal-message').textContent = message;
        document.getElementById('modal').classList.remove('hidden');
    }

    window.closeModal = function() {
        document.getElementById('modal').classList.add('hidden');
    }

    window.showConfirmModal = function(message, action) {
        document.getElementById('confirm-modal-message').textContent = message;
        pendingAction = action;
        document.getElementById('confirm-modal').classList.remove('hidden');
    }

    window.cancelAction = function() {
        pendingAction = null;
        document.getElementById('confirm-modal').classList.add('hidden');
    }

    window.executeAction = function() {
        if (pendingAction) {
            pendingAction();
        }
        pendingAction = null;
        document.getElementById('confirm-modal').classList.add('hidden');
    }
    
    // --- GROUP MANAGEMENT ---
    window.addGroup = async function() {
        const groupNameInput = document.getElementById('new-group-name');
        const groupName = groupNameInput.value.trim();
        const errorEl = document.getElementById('group-error');

        if (!groupName) {
            errorEl.textContent = 'El nombre del grupo no puede estar vacío.';
            errorEl.classList.remove('hidden');
            return;
        }

        errorEl.classList.add('hidden');
        try {
            await addDoc(collection(db, 'artifacts', appId, 'users', userId, 'groups'), {
                name: groupName
            });
            groupNameInput.value = '';
            showModal("Grupo Creado", `El grupo "${groupName}" ha sido creado con éxito.`);
        } catch (error) {
            console.error("Error adding group:", error);
            showModal("Error", "No se pudo crear el grupo.");
        }
    }

    window.deleteGroup = function(groupId, groupName) {
        showConfirmModal(`¿Estás seguro de que quieres eliminar el grupo "${groupName}"? Esta acción eliminará el grupo y desvinculará a los estudiantes asociados.`, async () => {
            try {
                const batch = writeBatch(db);
                
                // Unassign students from this group
                const studentsToUpdate = students.filter(s => s.groupId === groupId);
                studentsToUpdate.forEach(student => {
                    const studentRef = doc(db, 'artifacts', appId, 'users', userId, 'students', student.id);
                    batch.update(studentRef, { groupId: '' });
                });
                
                // Delete the group document
                const groupRef = doc(db, 'artifacts', appId, 'users', userId, 'groups', groupId);
                batch.delete(groupRef);
                
                await batch.commit();

                showModal("Grupo Eliminado", `El grupo "${groupName}" ha sido eliminado.`);
            } catch (error) {
                console.error("Error deleting group:", error);
                showModal("Error", "No se pudo eliminar el grupo.");
            }
        });
    }
    
    function renderGroups() {
        const list = document.getElementById('groups-list');
        list.innerHTML = '';
        if (groups.length === 0) {
            list.innerHTML = '<li class="text-gray-500">No hay grupos creados.</li>';
        }
        groups.forEach(group => {
            const li = document.createElement('li');
            li.className = 'flex items-center justify-between p-3 bg-white rounded-xl shadow-sm';
            li.innerHTML = `
                <div>
                    <span class="text-gray-700 font-medium">${group.name}</span>
                </div>
                <button onclick="deleteGroup('${group.id}', '${group.name}')" class="text-red-500 hover:text-red-700 transition-colors duration-200" aria-label="Eliminar grupo">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" />
                    </svg>
                </button>
            `;
            list.appendChild(li);
        });
    }

    function renderStudentGroupSelect() {
        const select = document.getElementById('student-group-select');
        select.innerHTML = '';
        if (groups.length === 0) {
            select.innerHTML = '<option value="">Crea un grupo primero</option>';
            select.disabled = true;
        } else {
            groups.forEach(group => {
                const option = document.createElement('option');
                option.value = group.id;
                option.textContent = group.name;
                select.appendChild(option);
            });
            select.disabled = false;
        }
    }

    function renderGroupFilter() {
        const select = document.getElementById('group-filter-select');
        select.innerHTML = '<option value="">Todos los Grupos</option>';
        groups.forEach(group => {
            const option = document.createElement('option');
            option.value = group.id;
            option.textContent = group.name;
            select.appendChild(option);
        });
    }
    
    // --- STUDENT MANAGEMENT ---
    window.addStudentsInBulk = async function() {
        const studentNamesInput = document.getElementById('student-names-input');
        const studentNames = studentNamesInput.value.split('\n').map(name => name.trim()).filter(name => name.length > 0);
        const groupId = document.getElementById('student-group-select').value;
        const errorEl = document.getElementById('student-error');

        if (studentNames.length === 0) {
            errorEl.textContent = 'Por favor, ingresa al menos un nombre de estudiante.';
            errorEl.classList.remove('hidden');
            return;
        }
        
        if (!groupId) {
             errorEl.textContent = 'Debes seleccionar un grupo.';
             errorEl.classList.remove('hidden');
             return;
        }

        const existingStudentNames = students.map(s => s.name.toLowerCase());
        const newStudentsToAdd = [];
        const duplicateStudents = [];

        studentNames.forEach(name => {
            if (existingStudentNames.includes(name.toLowerCase())) {
                duplicateStudents.push(name);
            } else {
                newStudentsToAdd.push(name);
            }
        });

        if (duplicateStudents.length > 0) {
            errorEl.textContent = `Los siguientes estudiantes ya existen: ${duplicateStudents.join(', ')}.`;
            errorEl.classList.remove('hidden');
            return;
        }
        
        errorEl.classList.add('hidden');
        try {
            const batch = writeBatch(db);
            newStudentsToAdd.forEach(name => {
                const newDocRef = doc(collection(db, 'artifacts', appId, 'users', userId, 'students'));
                batch.set(newDocRef, {
                    name: name,
                    groupId: groupId || ''
                });
            });
            await batch.commit();

            studentNamesInput.value = '';
            document.getElementById('student-group-select').value = '';
            showModal("Estudiantes Añadidos", `Se han añadido ${newStudentsToAdd.length} estudiantes.`);
        } catch (error) {
            console.error("Error adding students in bulk:", error);
            showModal("Error", "No se pudieron añadir los estudiantes.");
        }
    }

    window.deleteStudent = function(studentId, studentName) {
        showConfirmModal(`¿Estás seguro de que quieres eliminar a "${studentName}""?`, async () => {
            try {
                await deleteDoc(doc(db, 'artifacts', appId, 'users', userId, 'students', studentId));
                showModal("Estudiante Eliminado", `El estudiante "${studentName}" ha sido eliminado.`);
            } catch (error) {
                console.error("Error deleting student:", error);
                showModal("Error", "No se pudo eliminar el estudiante.");
            }
        });
    }

    function renderStudentsByGroup() {
        const listContainer = document.getElementById('students-grouped-list');
        listContainer.innerHTML = '';

        // Group students by groupId
        const studentsByGroup = students.reduce((acc, student) => {
            const groupId = student.groupId || 'no-group';
            if (!acc[groupId]) {
                acc[groupId] = [];
            }
            acc[groupId].push(student);
            return acc;
        }, {});

        // Sort groups with 'no-group' at the end
        const sortedGroupIds = Object.keys(studentsByGroup).sort((a, b) => {
            if (a === 'no-group') return 1;
            if (b === 'no-group') return -1;
            const groupA = groups.find(g => g.id === a)?.name || 'Sin grupo';
            const groupB = groups.find(g => g.id === b)?.name || 'Sin grupo';
            return groupA.localeCompare(groupB);
        });

        if (students.length === 0) {
            listContainer.innerHTML = '<p class="text-gray-500">No hay estudiantes registrados.</p>';
            return;
        }

        sortedGroupIds.forEach(groupId => {
            const groupName = groups.find(g => g.id === groupId)?.name || 'Sin grupo';
            const groupStudents = studentsByGroup[groupId];
            
            const groupDiv = document.createElement('div');
            groupDiv.className = 'mb-4';
            groupDiv.innerHTML = `<h4 class="text-lg font-bold text-gray-800 mb-2">${groupName}</h4>`;
            
            const ul = document.createElement('ul');
            ul.className = 'space-y-2';

            groupStudents.forEach(student => {
                const li = document.createElement('li');
                li.className = 'flex items-center justify-between p-3 bg-white rounded-xl shadow-sm';
                li.innerHTML = `
                    <div>
                        <span class="font-medium text-gray-800">${student.name}</span>
                    </div>
                    <button onclick="deleteStudent('${student.id}', '${student.name}')" class="text-red-500 hover:text-red-700 transition-colors duration-200" aria-label="Eliminar estudiante">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" />
                        </svg>
                    </button>
                `;
                ul.appendChild(li);
            });
            
            groupDiv.appendChild(ul);
            listContainer.appendChild(groupDiv);
        });
    }

    // --- ATTENDANCE MANAGEMENT ---
    let dailyAttendance = {};
    window.filterAttendanceByGroup = function() {
        const selectedGroupId = document.getElementById('group-filter-select').value;
        let filteredStudents = students;
        if (selectedGroupId) {
            filteredStudents = students.filter(s => s.groupId === selectedGroupId);
        }
        renderAttendanceList(filteredStudents);
    }
    
    window.loadDailyAttendance = function() {
        const dateInput = document.getElementById('attendance-date');
        const selectedDate = dateInput.value || new Date().toISOString().slice(0, 10);
        dateInput.value = selectedDate;
        
        dailyAttendance = {};
        const todayAttendance = attendance[selectedDate] || {};
        
        students.forEach(student => {
            dailyAttendance[student.id] = todayAttendance[student.id] || 'P'; // Default to Present
        });
        filterAttendanceByGroup();
    }

    function renderAttendanceList(filteredStudents = students) {
        const list = document.getElementById('attendance-list');
        list.innerHTML = '';
        if (filteredStudents.length === 0) {
            list.innerHTML = '<p class="text-gray-500 col-span-full">No hay estudiantes para registrar la asistencia en este grupo.</p>';
        }
        filteredStudents.forEach(student => {
            const status = dailyAttendance[student.id] || 'P';
            let bgColor, statusChar;
            switch(status) {
                case 'P':
                    bgColor = 'bg-green-100';
                    statusChar = 'P';
                    break;
                case 'T':
                    bgColor = 'bg-yellow-100';
                    statusChar = 'T';
                    break;
                case 'A':
                    bgColor = 'bg-red-100';
                    statusChar = 'A';
                    break;
                default:
                    bgColor = 'bg-green-100';
                    statusChar = 'P';
            }

            const card = document.createElement('div');
            card.className = `p-4 rounded-xl shadow-md transition-colors duration-200 cursor-pointer ${bgColor}`;
            card.onclick = () => toggleAttendance(student.id);
            card.innerHTML = `
                <div class="flex items-center space-x-3">
                    <span class="w-10 h-10 flex items-center justify-center rounded-full font-bold text-lg ${status === 'P' ? 'bg-green-600' : status === 'T' ? 'bg-yellow-500' : 'bg-red-600'} text-white">
                        ${statusChar}
                    </span>
                    <span class="font-medium text-gray-800">${student.name}</span>
                </div>
            `;
            list.appendChild(card);
        });
    }
    
    window.toggleAttendance = function(studentId) {
        const currentStatus = dailyAttendance[studentId];
        let newStatus;
        switch(currentStatus) {
            case 'P':
                newStatus = 'T';
                break;
            case 'T':
                newStatus = 'A';
                break;
            case 'A':
            default:
                newStatus = 'P';
        }
        dailyAttendance[studentId] = newStatus;
        filterAttendanceByGroup();
    }

    window.saveAttendance = async function() {
        const date = document.getElementById('attendance-date').value;
        if (!date) {
            showModal("Error", "Por favor, selecciona una fecha para guardar la asistencia.");
            return;
        }

        try {
            const attendanceDocRef = doc(db, 'artifacts', appId, 'users', userId, 'attendance', date);
            await setDoc(attendanceDocRef, dailyAttendance, { merge: true });
            showModal("Asistencia Guardada", `La asistencia para el ${date} ha sido guardada con éxito.`);
        } catch (error) {
            console.error("Error saving attendance:", error);
            showModal("Error", "No se pudo guardar la asistencia.");
        }
    }
    
    function calculateReport() {
        const report = {};
        const attendanceData = Object.keys(attendance).sort();

        attendanceData.forEach(date => {
            const [year, month, day] = date.split('-');
            const months = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
            const monthYearKey = `${months[parseInt(month) - 1]} ${year}`;

            if (!report[monthYearKey]) {
                report[monthYearKey] = {
                    totalDays: 0,
                    studentData: {}
                };
                students.forEach(student => {
                    report[monthYearKey].studentData[student.id] = {
                        name: student.name,
                        present: 0,
                        tardies: 0,
                        absent: 0
                    };
                });
            }
            
            report[monthYearKey].totalDays++;

            Object.keys(attendance[date]).forEach(studentId => {
                const status = attendance[date][studentId];
                if (report[monthYearKey].studentData[studentId]) {
                    switch(status) {
                        case 'P':
                            report[monthYearKey].studentData[studentId].present++;
                            break;
                        case 'T':
                            report[monthYearKey].studentData[studentId].tardies++;
                            break;
                        case 'A':
                            report[monthYearKey].studentData[studentId].absent++;
                            break;
                    }
                }
            });
        });

        // Aplicar la regla de 3 tardanzas = 1 ausencia
        for (const monthYear in report) {
            const monthData = report[monthYear];
            for (const studentId in monthData.studentData) {
                const student = monthData.studentData[studentId];
                const convertedAbsences = Math.floor(student.tardies / 3);
                student.absent += convertedAbsences;
                student.tardies = student.tardies % 3;
            }
        }

        // Calcular porcentaje de asistencia
        for (const monthYear in report) {
            const monthData = report[monthYear];
            const totalDaysRegistered = monthData.totalDays;
            for (const studentId in monthData.studentData) {
                const student = monthData.studentData[studentId];
                if (totalDaysRegistered > 0) {
                    student.attendancePercentage = (((student.present + student.tardies / 3) * 100) / totalDaysRegistered).toFixed(2);
                } else {
                    student.attendancePercentage = 0;
                }
            }
        }
        return report;
    }

    window.generateReport = async function() {
        const report = calculateReport();
        const reportOutput = document.getElementById('report-output');
        reportOutput.innerHTML = '';
        const reportSection = document.getElementById('report-section');
        reportSection.classList.remove('hidden');

        if (Object.keys(report).length === 0) {
            reportOutput.innerHTML = '<p class="text-gray-500">No hay datos de asistencia para generar un reporte.</p>';
            return;
        }

        for (const monthYear in report) {
            const monthData = report[monthYear];
            const section = document.createElement('div');
            section.className = 'report-section mb-6';
            section.innerHTML = `
                <h4 class="text-xl font-bold text-gray-800 mb-2">${monthYear}</h4>
                <p class="text-sm text-gray-600 mb-4">Días de asistencia registrados: ${monthData.totalDays}</p>
                <div class="bg-white p-4 rounded-lg shadow-sm">
                    <h5 class="font-semibold text-gray-700 mb-2">Resumen por estudiante:</h5>
                    <ul class="divide-y divide-gray-200">
                        ${Object.values(monthData.studentData).map(student => `
                            <li class="py-2 flex justify-between items-center">
                                <span class="font-medium text-gray-800">${student.name}</span>
                                <div class="text-sm space-x-2">
                                    <span class="text-green-600 font-semibold">${student.present}P</span>
                                    <span class="text-yellow-600 font-semibold">${student.tardies}T</span>
                                    <span class="text-red-600 font-semibold">${student.absent}A</span>
                                    <span class="text-blue-600 font-semibold">${student.attendancePercentage}%</span>
                                </div>
                            </li>
                        `).join('')}
                    </ul>
                </div>
            `;
            reportOutput.appendChild(section);
        }
    }

    // --- GRADES MANAGEMENT ---
    window.renderStudentGradeSelect = function() {
        const select = document.getElementById('student-grade-select');
        select.innerHTML = '<option value="">Seleccionar estudiante</option>';
        const sortedStudents = [...students].sort((a, b) => {
            const groupA = groups.find(g => g.id === a.groupId)?.name || 'Sin grupo';
            const groupB = groups.find(g => g.id === b.groupId)?.name || 'Sin grupo';
            if (groupA < groupB) return -1;
            if (groupA > groupB) return 1;
            return a.name.localeCompare(b.name);
        });

        sortedStudents.forEach(student => {
            const groupName = student.groupId ? (groups.find(g => g.id === student.groupId)?.name || 'Grupo desconocido') : 'Sin grupo';
            const option = document.createElement('option');
            option.value = student.id;
            option.textContent = `${student.name} (${groupName})`;
            select.appendChild(option);
        });
    }
    
    document.getElementById('period-pattern-input').addEventListener('change', (event) => {
        periodPattern = event.target.value.split(',').map(p => p.trim()).filter(p => p.length > 0);
        updatePeriodDisplay();
    });

    window.updatePeriodDisplay = function() {
        const studentId = document.getElementById('student-grade-select').value;
        const patternDisplay = document.getElementById('pattern-display');
        patternDisplay.innerHTML = '';
        const periodSelect = document.getElementById('period-select');
        
        // Clear the select box
        periodSelect.innerHTML = '<option value="">Seleccionar Periodo</option>';

        // If no student is selected, just show the default pattern
        if (!studentId) {
            periodPattern.forEach(period => {
                const option = document.createElement('option');
                option.value = period;
                option.textContent = period;
                periodSelect.appendChild(option);

                const periodElement = document.createElement('div');
                periodElement.classList.add('period-step', 'py-1', 'px-3', 'rounded-full', 'font-medium', 'text-sm', 'text-center', 'select-none', 'transition-colors', 'duration-200');
                periodElement.classList.add('bg-gray-200', 'text-gray-700', 'shadow-sm');
                periodElement.textContent = period;
                patternDisplay.appendChild(periodElement);
            });
            return;
        }
        
        const studentGrades = grades.filter(g => g.studentId === studentId);
        
        const lastGrade = studentGrades.length > 0 
            ? studentGrades.reduce((latest, current) => latest.timestamp.toDate().getTime() > current.timestamp.toDate().getTime() ? latest : current, studentGrades[0])
            : null;
        
        let nextPeriodIndex = 0;
        let lastPeriodGrade = -1;

        if (lastGrade) {
            const lastPeriodIndex = periodPattern.indexOf(lastGrade.period);
            nextPeriodIndex = (lastPeriodIndex + 1) % periodPattern.length;
            
            const lastNonRPGrades = studentGrades.filter(g => g.period !== 'RP');
            const lastNonRPGrade = lastNonRPGrades.length > 0 
                ? lastNonRPGrades.reduce((latest, current) => latest.timestamp.toDate().getTime() > current.timestamp.toDate().getTime() ? latest : current, lastNonRPGrades[0])
                : null;
            if (lastNonRPGrade) {
                lastPeriodGrade = lastNonRPGrade.grade;
            }
        }

        // Build the pattern display and select options based on the condition
        periodPattern.forEach((period, index) => {
            let periodToAdd = period;
            let displayElementClass = 'bg-gray-200 text-gray-700 shadow-sm';
            
            if (period === 'RP') {
                const lastNonRPPeriodIndex = index - 1;
                const lastNonRPPeriod = periodPattern[lastNonRPPeriodIndex];
                const gradeForLastNonRP = studentGrades
                    .filter(g => g.period === lastNonRPPeriod)
                    .sort((a, b) => b.timestamp.toDate().getTime() - a.timestamp.toDate().getTime())[0];

                if (gradeForLastNonRP && gradeForLastNonRP.grade >= 70) {
                    // Do not show RP if the student passed the previous period
                    return;
                }
            }

            if (index === nextPeriodIndex) {
                displayElementClass = 'active bg-blue-600 text-white shadow-lg';
            }

            // Create and append the select option
            const option = document.createElement('option');
            option.value = periodToAdd;
            option.textContent = periodToAdd;
            if (index === nextPeriodIndex) {
                 option.selected = true;
            }
            periodSelect.appendChild(option);

            // Create and append the visual element
            const periodElement = document.createElement('div');
            periodElement.classList.add('period-step', 'py-1', 'px-3', 'rounded-full', 'font-medium', 'text-sm', 'text-center', 'select-none', 'transition-colors', 'duration-200');
            periodElement.classList.add(...displayElementClass.split(' '));
            periodElement.textContent = periodToAdd;
            patternDisplay.appendChild(periodElement);
        });
    };

    window.addGrade = async function() {
        const studentId = document.getElementById('student-grade-select').value;
        const period = document.getElementById('period-select').value;
        const gradeInput = document.getElementById('grade-input');
        const grade = parseInt(gradeInput.value, 10);
        const reason = document.getElementById('grade-reason-select').value;
        const note = document.getElementById('grade-note-input').value.trim();

        if (!studentId || !period) {
            showModal("Error", "Por favor, selecciona un estudiante y un periodo.");
            return;
        }
        
        if (isNaN(grade) || grade < 0 || grade > 100) {
            showModal("Error", "Por favor, introduce una calificación válida entre 0 y 100.");
            return;
        }

        try {
            await addDoc(collection(db, 'artifacts', appId, 'users', userId, 'grades'), {
                studentId: studentId,
                period: period,
                grade: grade,
                reason: reason || '',
                note: note || '',
                timestamp: new Date()
            });
            document.getElementById('student-grade-select').value = '';
            document.getElementById('period-select').value = '';
            gradeInput.value = '';
            document.getElementById('grade-reason-select').value = '';
            document.getElementById('grade-note-input').value = '';
            showModal("Calificación Guardada", "La calificación ha sido añadida con éxito.");
            updatePeriodDisplay(); // Refresh period display after adding a grade
        } catch (error) {
            console.error("Error adding grade:", error);
            showModal("Error", "No se pudo guardar la calificación.");
        }
    }
    
    window.editGrade = function(gradeId, currentGrade, currentReason, currentNote) {
        document.getElementById('edit-grade-id').value = gradeId;
        document.getElementById('edit-grade-input').value = currentGrade;
        document.getElementById('edit-grade-reason-select').value = currentReason || '';
        document.getElementById('edit-grade-note-input').value = currentNote || '';
        document.getElementById('edit-grade-modal').classList.remove('hidden');
    }

    window.saveEditedGrade = async function() {
        const gradeId = document.getElementById('edit-grade-id').value;
        const newGrade = parseInt(document.getElementById('edit-grade-input').value, 10);
        const newReason = document.getElementById('edit-grade-reason-select').value;
        const newNote = document.getElementById('edit-grade-note-input').value.trim();
        
        if (isNaN(newGrade) || newGrade < 0 || newGrade > 100) {
            showModal("Error", "Por favor, introduce una calificación válida entre 0 y 100.");
            return;
        }

        document.getElementById('edit-grade-modal').classList.add('hidden');
        try {
            await updateDoc(doc(db, 'artifacts', appId, 'users', userId, 'grades', gradeId), {
                grade: newGrade,
                reason: newReason || '',
                note: newNote || ''
            });
            showModal("Calificación Actualizada", "La calificación ha sido actualizada con éxito.");
        } catch (error) {
            console.error("Error updating grade:", error);
            showModal("Error", "No se pudo actualizar la calificación.");
        }
    }
    
    window.deleteGrade = function(gradeId) {
        showConfirmModal("¿Estás seguro de que quieres eliminar esta calificación?", async () => {
            try {
                await deleteDoc(doc(db, 'artifacts', appId, 'users', userId, 'grades', gradeId));
                showModal("Calificación Eliminada", "La calificación ha sido eliminada con éxito.");
            } catch (error) {
                console.error("Error deleting grade:", error);
                showModal("Error", "No se pudo eliminar la calificación.");
            }
        });
    }

    window.calculateFinalGrade = function(studentId) {
        const studentGrades = grades
            .filter(g => g.studentId === studentId)
            .sort((a, b) => a.timestamp.toDate().getTime() - b.timestamp.toDate().getTime());

        if (studentGrades.length < 30) {
            showModal("Error", `Se necesitan al menos 30 calificaciones para calcular la nota final. Este estudiante tiene ${studentGrades.length}.`);
            return;
        }

        // Split grades based on the provided example
        const grades70 = studentGrades.slice(0, 18);
        const grades30 = studentGrades.slice(18, 30);

        const sum70 = grades70.reduce((sum, g) => sum + g.grade, 0);
        const sum30 = grades30.reduce((sum, g) => sum + g.grade, 0);

        const final70 = sum70 * (0.70 / 16);
        const final30 = sum30 * (0.30 / 12);
        const finalGrade = Math.round(final70 + final30);

        const studentName = students.find(s => s.id === studentId)?.name || 'Estudiante desconocido';

        const content = `
            <h5 class="text-xl font-semibold mb-4 text-center">${studentName}</h5>
            <div class="mb-4 p-4 bg-gray-50 rounded-lg shadow-sm">
                <p class="font-medium text-gray-700">Cálculo del 70%:</p>
                <p class="text-sm text-gray-600">Suma de las primeras 18 calificaciones: ${sum70}</p>
                <p class="text-sm text-gray-600">Fórmula: (${sum70} * 0.70 / 16) = ${final70.toFixed(2)}</p>
            </div>
            <div class="mb-4 p-4 bg-gray-50 rounded-lg shadow-sm">
                <p class="font-medium text-gray-700">Cálculo del 30%:</p>
                <p class="text-sm text-gray-600">Suma de las siguientes 12 calificaciones: ${sum30}</p>
                <p class="text-sm text-gray-600">Fórmula: (${sum30} * 0.30 / 12) = ${final30.toFixed(2)}</p>
            </div>
            <div class="mt-6 text-center p-4 rounded-lg shadow-md ${finalGrade >= 70 ? 'bg-green-100' : 'bg-red-100'}">
                <p class="text-xl font-bold">Calificación Final:</p>
                <p class="text-4xl font-extrabold ${finalGrade >= 70 ? 'text-green-600' : 'text-red-600'}">${finalGrade}</p>
                <p class="font-medium ${finalGrade >= 70 ? 'text-green-800' : 'text-red-800'}">${finalGrade >= 70 ? '¡Aprobado!' : 'Reprobado'}</p>
            </div>
        `;
        document.getElementById('final-grade-content').innerHTML = content;
        document.getElementById('final-grade-modal').classList.remove('hidden');
    };

    window.showGradeNoteModal = function(gradeData) {
        const student = students.find(s => s.id === gradeData.studentId);
        document.getElementById('view-grade-note-student').textContent = student ? student.name : 'Desconocido';
        document.getElementById('view-grade-note-period').textContent = gradeData.period;
        document.getElementById('view-grade-note-grade').textContent = gradeData.grade;
        document.getElementById('view-grade-note-reason').textContent = gradeData.reason || 'No especificado';
        document.getElementById('view-grade-note-comment').textContent = gradeData.note || 'No hay nota adicional.';
        document.getElementById('view-grade-note-modal').classList.remove('hidden');
    };


    function renderGradesList() {
        const list = document.getElementById('grades-list');
        list.innerHTML = '';
        if (grades.length === 0) {
            list.innerHTML = '<li class="text-gray-500">No hay calificaciones registradas.</li>';
        }
        
        // Group grades by student
        const groupedGrades = grades.reduce((acc, grade) => {
            if (!acc[grade.studentId]) {
                acc[grade.studentId] = [];
            }
            acc[grade.studentId].push(grade);
            return acc;
        }, {});

        for (const studentId in groupedGrades) {
            const student = students.find(s => s.id === studentId);
            const studentName = student ? student.name : 'Estudiante desconocido';
            const groupName = student ? (groups.find(g => g.id === student.groupId)?.name || 'Sin grupo') : 'Sin grupo';
            
            // Sort grades by timestamp to ensure correct order
            const studentGrades = groupedGrades[studentId].sort((a, b) => a.timestamp.toDate().getTime() - b.timestamp.toDate().getTime());

            const li = document.createElement('li');
            li.className = 'p-4 bg-white rounded-xl shadow-sm mb-4';
            li.innerHTML = `
                <div class="flex items-center justify-between mb-2">
                    <span class="font-medium text-gray-800">${studentName}</span>
                    <span class="text-sm text-gray-700 font-semibold">(${groupName})</span>
                    <button onclick="calculateFinalGrade('${studentId}')" class="bg-indigo-500 hover:bg-indigo-600 text-white text-xs font-semibold py-1 px-3 rounded-full transition-colors duration-200 shadow-md">
                        Calcular Nota Final
                    </button>
                </div>
                <div class="flex flex-wrap gap-2">
                    ${studentGrades.map(grade => {
                        const cardClass = grade.grade < 70 ? 'grade-card-fail' : 'grade-card-pass';
                        return `
                            <div class="grade-card-container p-2 text-center border rounded-lg ${cardClass}">
                                <span class="block text-xs font-semibold text-gray-800 mb-1">${grade.period}</span>
                                <p class="text-lg font-bold ${grade.grade < 70 ? 'text-red-600' : 'text-green-600'}">${grade.grade}</p>
                                <div class="grade-actions">
                                    <button onclick="showGradeNoteModal(${JSON.stringify(grade).replace(/'/g, '&#39;')})" class="bg-blue-500 text-white p-1 rounded-full hover:bg-blue-600 transition-colors duration-200" aria-label="Ver nota">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                          <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                          <path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                                        </svg>
                                    </button>
                                    <button onclick="editGrade('${grade.id}', ${grade.grade}, '${grade.reason}', '${grade.note}')" class="bg-blue-500 text-white p-1 rounded-full hover:bg-blue-600 transition-colors duration-200">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                            <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zm-5.657 5.657l-1.636 1.636a.5.5 0 00-.146.353v3.586a.5.5 0 00.5.5h3.586a.5.5 0 00.353-.146l1.636-1.636-2.828-2.828z" />
                                        </svg>
                                    </button>
                                    <button onclick="deleteGrade('${grade.id}')" class="bg-red-500 text-white p-1 rounded-full hover:bg-red-600 transition-colors duration-200">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" />
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
            list.appendChild(li);
        }
    }

    // --- ANECDOTE MANAGEMENT ---
    window.renderStudentAnecdoteSelect = function() {
        const select = document.getElementById('student-anecdote-select');
        select.innerHTML = '<option value="">Seleccionar estudiante</option>';
        const sortedStudents = [...students].sort((a, b) => {
            const groupA = groups.find(g => g.id === a.groupId)?.name || 'Sin grupo';
            const groupB = groups.find(g => g.id === b.groupId)?.name || 'Sin grupo';
            if (groupA < groupB) return -1;
            if (groupA > groupB) return 1;
            return a.name.localeCompare(b.name);
        });

        sortedStudents.forEach(student => {
            const groupName = student.groupId ? (groups.find(g => g.id === student.groupId)?.name || 'Grupo desconocido') : 'Sin grupo';
            const option = document.createElement('option');
            option.value = student.id;
            option.textContent = `${student.name} (${groupName})`;
            select.appendChild(option);
        });
    };

    window.addAnecdote = async function() {
        const studentId = document.getElementById('student-anecdote-select').value;
        const note = document.getElementById('anecdote-note-input').value.trim();
        const date = document.getElementById('anecdote-date-input').value;

        if (!studentId) {
            showModal("Error", "Por favor, selecciona un estudiante.");
            return;
        }

        if (!note) {
            showModal("Error", "La nota no puede estar vacía.");
            return;
        }

        if (!date) {
            showModal("Error", "Por favor, selecciona una fecha.");
            return;
        }

        try {
            await addDoc(collection(db, 'artifacts', appId, 'users', userId, 'anecdotes'), {
                studentId: studentId,
                note: note,
                date: date,
                timestamp: new Date()
            });
            document.getElementById('student-anecdote-select').value = '';
            document.getElementById('anecdote-note-input').value = '';
            document.getElementById('anecdote-date-input').value = new Date().toISOString().slice(0, 10);
            showModal("Nota Guardada", "La nota anecdótica ha sido guardada con éxito.");
        } catch (error) {
            console.error("Error adding anecdote:", error);
            showModal("Error", "No se pudo guardar la nota.");
        }
    };

    function renderAnecdotes() {
        const listContainer = document.getElementById('anecdotes-list');
        listContainer.innerHTML = '';

        // Group anecdotes by student
        const groupedAnecdotes = anecdotes.reduce((acc, anecdote) => {
            if (!acc[anecdote.studentId]) {
                acc[anecdote.studentId] = [];
            }
            acc[anecdote.studentId].push(anecdote);
            return acc;
        }, {});

        if (Object.keys(groupedAnecdotes).length === 0) {
            listContainer.innerHTML = '<p class="text-gray-500">No hay notas anecdóticas registradas.</p>';
            return;
        }

        for (const studentId in groupedAnecdotes) {
            const student = students.find(s => s.id === studentId);
            const studentName = student ? student.name : 'Estudiante desconocido';

            const studentDiv = document.createElement('div');
            studentDiv.className = 'mb-6';
            studentDiv.innerHTML = `<h4 class="text-lg font-bold text-gray-800 mb-2">${studentName}</h4>`;

            const ul = document.createElement('ul');
            ul.className = 'space-y-2';

            // Sort anecdotes by date, newest first
            const studentAnecdotes = groupedAnecdotes[studentId].sort((a, b) => new Date(b.date) - new Date(a.date));

            studentAnecdotes.forEach(anecdote => {
                const li = document.createElement('li');
                li.className = 'p-4 bg-white rounded-xl shadow-sm flex flex-col sm:flex-row justify-between items-start sm:items-center';
                li.innerHTML = `
                    <div class="flex-grow">
                        <p class="text-sm text-gray-500 mb-1">${anecdote.date}</p>
                        <p class="text-gray-700 whitespace-pre-wrap">${anecdote.note}</p>
                    </div>
                    <div class="flex space-x-2 mt-2 sm:mt-0">
                        <button onclick="editAnecdote('${anecdote.id}', '${anecdote.note}')" class="bg-blue-500 text-white p-2 rounded-full hover:bg-blue-600 transition-colors duration-200" aria-label="Editar">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zm-5.657 5.657l-1.636 1.636a.5.5 0 00-.146.353v3.586a.5.5 0 00.5.5h3.586a.5.5 0 00.353-.146l1.636-1.636-2.828-2.828z" />
                            </svg>
                        </button>
                        <button onclick="deleteAnecdote('${anecdote.id}')" class="bg-red-500 text-white p-2 rounded-full hover:bg-red-600 transition-colors duration-200" aria-label="Eliminar">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>
                `;
                ul.appendChild(li);
            });
            studentDiv.appendChild(ul);
            listContainer.appendChild(studentDiv);
        }
    }

    window.editAnecdote = function(anecdoteId, currentNote) {
        document.getElementById('edit-anecdote-id').value = anecdoteId;
        document.getElementById('edit-anecdote-note-input').value = currentNote;
        document.getElementById('edit-anecdote-modal').classList.remove('hidden');
    };

    window.saveEditedAnecdote = async function() {
        const anecdoteId = document.getElementById('edit-anecdote-id').value;
        const newNote = document.getElementById('edit-anecdote-note-input').value.trim();

        if (!newNote) {
            showModal("Error", "La nota no puede estar vacía.");
            return;
        }

        document.getElementById('edit-anecdote-modal').classList.add('hidden');
        try {
            await updateDoc(doc(db, 'artifacts', appId, 'users', userId, 'anecdotes', anecdoteId), {
                note: newNote
            });
            showModal("Nota Actualizada", "La nota anecdótica ha sido actualizada con éxito.");
        } catch (error) {
            console.error("Error updating anecdote:", error);
            showModal("Error", "No se pudo actualizar la nota.");
        }
    };

    window.deleteAnecdote = function(anecdoteId) {
        showConfirmModal("¿Estás seguro de que quieres eliminar esta nota?", async () => {
            try {
                await deleteDoc(doc(db, 'artifacts', appId, 'users', userId, 'anecdotes', anecdoteId));
                showModal("Nota Eliminada", "La nota anecdótica ha sido eliminada con éxito.");
            } catch (error) {
                console.error("Error deleting anecdote:", error);
                showModal("Error", "No se pudo eliminar la nota.");
            }
        });
    };

    // --- RENDERIZADO INICIAL ---
    initializeFirebase();
    activateTab('gestion');
</script>
</body>
</html>
