<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Calificaciones</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .hidden {
            display: none;
        }
        .tab-button.active {
            background-color: #3b82f6;
            color: white;
            box-shadow: 0 4px 6px rgba(59, 130, 246, 0.25);
        }
        .tab-button:not(.active) {
            background-color: transparent;
            color: #6b7280;
        }
        .tab-button:hover {
            background-color: #d1d5db;
        }
    </style>
</head>
<body>

    <div class="container mx-auto p-4 md:p-8">
        <h1 class="text-3xl md:text-4xl font-extrabold text-gray-900 mb-6 text-center">Gestión de Estudiantes y Calificaciones</h1>

        <div class="flex justify-center mb-6">
            <button class="tab-button active px-4 py-2 rounded-lg mr-2 font-medium" onclick="activateTab('gestion')">Gestión</button>
            <button class="tab-button px-4 py-2 rounded-lg mr-2 font-medium" onclick="activateTab('asistencia')">Asistencia</button>
            <button class="tab-button px-4 py-2 rounded-lg mr-2 font-medium" onclick="activateTab('calificaciones')">Calificaciones</button>
            <button class="tab-button px-4 py-2 rounded-lg font-medium" onclick="activateTab('estadisticas')">Estadísticas</button>
        </div>

        <div id="tab-container">

            <div id="gestion" class="tab-content">
                <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
                    <h2 class="text-2xl font-bold mb-4">Grupos y Estudiantes</h2>
                    <div class="mb-6">
                        <label for="new-group-name" class="block text-gray-700 font-bold mb-2">Crear Nuevo Grupo</label>
                        <div class="flex items-center">
                            <input type="text" id="new-group-name" placeholder="Nombre del grupo..." class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                            <button onclick="addGroup()" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded ml-2 focus:outline-none focus:shadow-outline">Añadir Grupo</button>
                        </div>
                        <p id="group-error" class="text-red-500 text-xs italic hidden mt-1"></p>
                    </div>

                    <div class="mb-6">
                        <label for="student-names-input" class="block text-gray-700 font-bold mb-2">Añadir Estudiantes (uno por línea)</label>
                        <textarea id="student-names-input" rows="5" placeholder="Nombre Apellido&#10;Nombre Apellido" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline mb-2"></textarea>
                        <label for="student-group-select" class="block text-gray-700 font-bold mb-2">Seleccionar Grupo</label>
                        <select id="student-group-select" class="shadow border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline mb-2"></select>
                        <button onclick="addStudentsInBulk()" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">Añadir Estudiantes</button>
                        <p id="student-error" class="text-red-500 text-xs italic hidden mt-1"></p>
                    </div>

                    <div id="groups-list" class="mb-6">
                        </div>

                    <div id="students-list" class="mb-6">
                        </div>

                </div>
            </div>

            <div id="asistencia" class="tab-content hidden">
                <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
                    <h2 class="text-2xl font-bold mb-4">Control de Asistencia</h2>
                    <div class="mb-4">
                        <label for="attendance-date" class="block text-gray-700 font-bold mb-2">Fecha:</label>
                        <input type="date" id="attendance-date" class="shadow appearance-none border rounded py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    </div>
                    <div id="attendance-list" class="mb-4">
                        </div>
                    <button onclick="saveAttendance()" class="bg-purple-500 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">Guardar Asistencia</button>
                </div>
            </div>

            <div id="calificaciones" class="tab-content hidden">
                <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
                    <h2 class="text-2xl font-bold mb-4">Calificaciones y Notas Anécdoticas</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h3 class="text-xl font-bold mb-2">Añadir Calificación</h3>
                            <div class="mb-4">
                                <label for="student-grade-select" class="block text-gray-700 font-bold mb-2">Estudiante</label>
                                <select id="student-grade-select" class="shadow border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"></select>
                            </div>
                            <div class="mb-4">
                                <label for="period-select" class="block text-gray-700 font-bold mb-2">Periodo</label>
                                <select id="period-select" class="shadow border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                                    <option value="P1">P1</option>
                                    <option value="P2">P2</option>
                                    <option value="P3">P3</option>
                                    <option value="P4">P4</option>
                                    <option value="RP">RP</option>
                                </select>
                            </div>
                            <div class="mb-4">
                                <label for="grade-input" class="block text-gray-700 font-bold mb-2">Calificación (0-100)</label>
                                <input type="number" id="grade-input" min="0" max="100" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                            </div>
                            <div class="mb-4">
                                <label for="grade-reason-select" class="block text-gray-700 font-bold mb-2">Motivo</label>
                                <select id="grade-reason-select" class="shadow border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                                    <option value="">Selecciona un motivo</option>
                                    <option value="Evaluación continua">Evaluación continua</option>
                                    <option value="Examen">Examen</option>
                                    <option value="Trabajo en clase">Trabajo en clase</option>
                                    <option value="Tarea">Tarea</option>
                                    <option value="Participación">Participación</option>
                                </select>
                            </div>
                            <div class="mb-4">
                                <label for="grade-note-input" class="block text-gray-700 font-bold mb-2">Nota</label>
                                <textarea id="grade-note-input" rows="2" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"></textarea>
                            </div>
                            <button onclick="addGrade()" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">Guardar Calificación</button>
                        </div>

                        <div>
                            <h3 class="text-xl font-bold mb-2">Añadir Nota Anécdotica</h3>
                            <div class="mb-4">
                                <label for="student-anecdote-select" class="block text-gray-700 font-bold mb-2">Estudiante</label>
                                <select id="student-anecdote-select" class="shadow border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"></select>
                            </div>
                            <div class="mb-4">
                                <label for="anecdote-date-input" class="block text-gray-700 font-bold mb-2">Fecha</label>
                                <input type="date" id="anecdote-date-input" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                            </div>
                            <div class="mb-4">
                                <label for="anecdote-note-input" class="block text-gray-700 font-bold mb-2">Nota</label>
                                <textarea id="anecdote-note-input" rows="5" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"></textarea>
                            </div>
                            <button onclick="addAnecdote()" class="bg-yellow-500 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">Guardar Nota</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="estadisticas" class="tab-content hidden">
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h2 class="text-2xl font-bold mb-4">Estadísticas y Resumen</h2>
                    <div id="stats-content">
                        </div>
                </div>
            </div>

        </div>
    </div>

    <div id="confirm-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900" id="confirm-modal-title"></h3>
                <div class="mt-2 px-7 py-3">
                    <p class="text-sm text-gray-500" id="confirm-modal-message"></p>
                </div>
                <div class="items-center px-4 py-3">
                    <button id="confirm-yes-btn" class="px-4 py-2 bg-red-500 text-white text-base font-medium rounded-md w-24 mr-2 shadow-sm hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500">Sí</button>
                    <button id="confirm-no-btn" class="px-4 py-2 bg-gray-500 text-white text-base font-medium rounded-md w-24 shadow-sm hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500">No</button>
                </div>
            </div>
        </div>
    </div>

    <div id="message-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900" id="message-modal-title"></h3>
                <div class="mt-2 px-7 py-3">
                    <p class="text-sm text-gray-500" id="message-modal-message"></p>
                </div>
                <div class="items-center px-4 py-3">
                    <button id="message-ok-btn" class="px-4 py-2 bg-blue-500 text-white text-base font-medium rounded-md w-24 shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">OK</button>
                </div>
            </div>
        </div>
    </div>

    <div id="edit-grade-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900">Editar Calificación</h3>
                <input type="hidden" id="edit-grade-id">
                <div class="mt-2 px-7 py-3 text-left">
                    <label for="edit-grade-input" class="block text-gray-700 font-bold mb-2">Calificación (0-100)</label>
                    <input type="number" id="edit-grade-input" min="0" max="100" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    <label for="edit-grade-reason-select" class="block text-gray-700 font-bold mb-2 mt-4">Motivo</label>
                    <select id="edit-grade-reason-select" class="shadow border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                        <option value="">Selecciona un motivo</option>
                        <option value="Evaluación continua">Evaluación continua</option>
                        <option value="Examen">Examen</option>
                        <option value="Trabajo en clase">Trabajo en clase</option>
                        <option value="Tarea">Tarea</option>
                        <option value="Participación">Participación</option>
                    </select>
                    <label for="edit-grade-note-input" class="block text-gray-700 font-bold mb-2 mt-4">Nota</label>
                    <textarea id="edit-grade-note-input" rows="2" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"></textarea>
                </div>
                <div class="items-center px-4 py-3">
                    <button id="save-edited-grade-btn" onclick="saveEditedGrade()" class="px-4 py-2 bg-green-500 text-white text-base font-medium rounded-md w-24 mr-2 shadow-sm hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500">Guardar</button>
                    <button id="cancel-edited-grade-btn" onclick="document.getElementById('edit-grade-modal').classList.add('hidden')" class="px-4 py-2 bg-gray-500 text-white text-base font-medium rounded-md w-24 shadow-sm hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500">Cancelar</button>
                </div>
            </div>
        </div>
    </div>

    <div id="edit-anecdote-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900">Editar Nota Anécdotica</h3>
                <input type="hidden" id="edit-anecdote-id">
                <div class="mt-2 px-7 py-3 text-left">
                    <label for="edit-anecdote-note-input" class="block text-gray-700 font-bold mb-2">Nota</label>
                    <textarea id="edit-anecdote-note-input" rows="5" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"></textarea>
                </div>
                <div class="items-center px-4 py-3">
                    <button id="save-edited-anecdote-btn" onclick="saveEditedAnecdote()" class="px-4 py-2 bg-green-500 text-white text-base font-medium rounded-md w-24 mr-2 shadow-sm hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500">Guardar</button>
                    <button id="cancel-edited-anecdote-btn" onclick="document.getElementById('edit-anecdote-modal').classList.add('hidden')" class="px-4 py-2 bg-gray-500 text-white text-base font-medium rounded-md w-24 shadow-sm hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500">Cancelar</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBsTK0Ax5tzjX4mz25n4hoGVotIuUkKrFo",
            authDomain: "edusistem-eef5e.firebaseapp.com",
            projectId: "edusistem-eef5e",
            storageBucket: "edusistem-eef5e.firebasestorage.app",
            messagingSenderId: "328823083464",
            appId: "1:328823083464:web:0481e90cab31664474b0fd",
            measurementId: "G-K9KKDY141H"
        };
        const appId = "1:328823083464:web:0481e90cab31664474b0fd";
        const initialAuthToken = null;

        let db;
        let auth;
        let userId;

        let groups = [];
        let students = [];
        let attendance = {};
        let grades = [];
        let anecdotes = [];
        let periodPattern = ['P1', 'P2', 'RP', 'P3', 'P4', 'RP', 'P1', 'P2', 'RP', 'P3', 'P4', 'RP', 'P1', 'P2', 'RP', 'P3', 'P4', 'RP', 'P1', 'P2', 'RP', 'P3', 'P4', 'RP'];

        async function initializeFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // Autenticación anónima para simplicidad
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        startDataListeners();
                    } else {
                        console.log("No user is signed in.");
                        showModal("Error de Autenticación", "No se pudo iniciar sesión. La aplicación no funcionará correctamente.");
                    }
                });
            } catch (error) {
                console.error("Error initializing Firebase:", error);
                showModal("Error", "No se pudo conectar a la base de datos de Firebase. Por favor, revisa tu conexión.");
            }
        }

        function startDataListeners() {
            onSnapshot(collection(db, 'artifacts', appId, 'users', userId, 'groups'), (snapshot) => {
                groups = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateUI();
            }, (error) => console.error("Error listening to groups:", error));

            onSnapshot(collection(db, 'artifacts', appId, 'users', userId, 'students'), (snapshot) => {
                students = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateUI();
            }, (error) => console.error("Error listening to students:", error));

            onSnapshot(collection(db, 'artifacts', appId, 'users', userId, 'attendance'), (snapshot) => {
                attendance = {};
                snapshot.docs.forEach(doc => {
                    attendance[doc.id] = doc.data().records;
                });
                updateUI();
            }, (error) => console.error("Error listening to attendance:", error));

            onSnapshot(collection(db, 'artifacts', appId, 'users', userId, 'grades'), (snapshot) => {
                grades = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateUI();
            }, (error) => console.error("Error listening to grades:", error));

            onSnapshot(collection(db, 'artifacts', appId, 'users', userId, 'anecdotes'), (snapshot) => {
                anecdotes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateUI();
            }, (error) => console.error("Error listening to anecdotes:", error));
        }

        async function loadDataOnce() {
            // No need to load once if using real-time listeners
        }

        // Funciones de utilidad para el DOM
        function showModal(title, message) {
            const modal = document.getElementById('message-modal');
            document.getElementById('message-modal-title').textContent = title;
            document.getElementById('message-modal-message').textContent = message;
            modal.classList.remove('hidden');
        }

        function showConfirmModal(message, onConfirm) {
            const modal = document.getElementById('confirm-modal');
            const titleEl = document.getElementById('confirm-modal-title');
            const messageEl = document.getElementById('confirm-modal-message');
            const yesBtn = document.getElementById('confirm-yes-btn');
            const noBtn = document.getElementById('confirm-no-btn');

            titleEl.textContent = 'Confirmación';
            messageEl.textContent = message;

            yesBtn.onclick = () => {
                onConfirm();
                modal.classList.add('hidden');
            };

            noBtn.onclick = () => {
                modal.classList.add('hidden');
            };
            modal.classList.remove('hidden');
        }

        document.getElementById('message-ok-btn').onclick = () => {
            document.getElementById('message-modal').classList.add('hidden');
        };

        function activateTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
            document.getElementById(tabId).classList.remove('hidden');
            document.querySelectorAll('.tab-button').forEach(button => button.classList.remove('active'));
            document.querySelector(`.tab-button[onclick="activateTab('${tabId}')"]`).classList.add('active');
            updateUI();
        }

        function updateUI() {
            renderGroupsAndStudents();
            renderAttendanceList();
            renderGradesAndAnecdotes();
            renderStatistics();
        }

        function renderGroupsAndStudents() {
            const groupsList = document.getElementById('groups-list');
            const studentsList = document.getElementById('students-list');
            const studentGroupSelect = document.getElementById('student-group-select');
            const studentGradeSelect = document.getElementById('student-grade-select');
            const studentAnecdoteSelect = document.getElementById('student-anecdote-select');

            groupsList.innerHTML = `
                <h3 class="text-xl font-bold mb-2">Grupos</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    ${groups.map(group => `
                        <div class="bg-gray-100 p-4 rounded-lg shadow-sm flex items-center justify-between">
                            <span class="font-medium">${group.name} (${students.filter(s => s.groupId === group.id).length})</span>
                            <button onclick="deleteGroup('${group.id}', '${group.name}')" class="bg-red-500 hover:bg-red-700 text-white font-bold p-1 rounded text-sm"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.728-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 112 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" />
                            </svg></button>
                        </div>
                    `).join('')}
                </div>
            `;

            studentsList.innerHTML = `
                <h3 class="text-xl font-bold mb-2 mt-6">Estudiantes</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    ${students.map(student => `
                        <div class="bg-gray-100 p-4 rounded-lg shadow-sm flex items-center justify-between">
                            <span class="font-medium">${student.name} (${groups.find(g => g.id === student.groupId)?.name || 'Sin Grupo'})</span>
                            <button onclick="deleteStudent('${student.id}', '${student.name}')" class="bg-red-500 hover:bg-red-700 text-white font-bold p-1 rounded text-sm"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.728-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 112 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" />
                            </svg></button>
                        </div>
                    `).join('')}
                </div>
            `;

            studentGroupSelect.innerHTML = `<option value="">Selecciona un grupo</option>` + groups.map(group => `<option value="${group.id}">${group.name}</option>`).join('');
            studentGradeSelect.innerHTML = `<option value="">Selecciona un estudiante</option>` + students.map(student => `<option value="${student.id}">${student.name}</option>`).join('');
            studentAnecdoteSelect.innerHTML = `<option value="">Selecciona un estudiante</option>` + students.map(student => `<option value="${student.id}">${student.name}</option>`).join('');
        }

        function renderAttendanceList() {
            const attendanceList = document.getElementById('attendance-list');
            const date = document.getElementById('attendance-date').value;
            const records = attendance[date] || {};

            attendanceList.innerHTML = students.map(student => `
                <div class="flex items-center mb-2">
                    <input type="checkbox" id="${student.id}" class="form-checkbox h-5 w-5 text-blue-600 mr-2" ${records[student.id] ? 'checked' : ''}>
                    <label for="${student.id}" class="text-gray-700">${student.name}</label>
                </div>
            `).join('');
        }

        function renderGradesAndAnecdotes() {
            const gradesContent = document.getElementById('grades-content');
            const anecdotesContent = document.getElementById('anecdotes-content');
            const studentId = document.getElementById('student-grade-select').value;
            const filteredGrades = grades.filter(g => g.studentId === studentId);
            const filteredAnecdotes = anecdotes.filter(a => a.studentId === studentId);

            // This part is in the grades tab
            const gradesTable = document.getElementById('grades-table');
            const anecdotesTable = document.getElementById('anecdotes-table');

            // Renderizado de calificaciones
            const gradesHtml = students.map(student => {
                const studentGrades = grades.filter(g => g.studentId === student.id);
                const gradeRows = studentGrades.length > 0
                    ? studentGrades.map(grade => `
                        <tr class="hover:bg-gray-100">
                            <td class="px-6 py-4 whitespace-nowrap">${grade.period}</td>
                            <td class="px-6 py-4 whitespace-nowrap">${grade.grade}</td>
                            <td class="px-6 py-4 whitespace-nowrap">${grade.reason}</td>
                            <td class="px-6 py-4 whitespace-nowrap">${grade.note}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-right">
                                <button onclick="editGrade('${grade.id}')" class="text-blue-600 hover:text-blue-900 mr-2">Editar</button>
                                <button onclick="deleteGrade('${grade.id}')" class="text-red-600 hover:text-red-900">Eliminar</button>
                            </td>
                        </tr>
                    `).join('')
                    : `<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">No hay calificaciones.</td></tr>`;
                
                return `
                    <div class="bg-gray-100 p-4 rounded-lg mb-4">
                        <h4 class="font-bold text-lg mb-2">${student.name}</h4>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Periodo</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Calificación</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Motivo</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nota</th>
                                        <th scope="col" class="relative px-6 py-3"><span class="sr-only">Acciones</span></th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    ${gradeRows}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            }).join('');

            // Renderizado de anécdotas
            const anecdotesHtml = students.map(student => {
                const studentAnecdotes = anecdotes.filter(a => a.studentId === student.id);
                const anecdoteRows = studentAnecdotes.length > 0
                    ? studentAnecdotes.map(anecdote => `
                        <tr class="hover:bg-gray-100">
                            <td class="px-6 py-4 whitespace-nowrap">${anecdote.date}</td>
                            <td class="px-6 py-4 whitespace-nowrap">${anecdote.note}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-right">
                                <button onclick="editAnecdote('${anecdote.id}')" class="text-blue-600 hover:text-blue-900 mr-2">Editar</button>
                                <button onclick="deleteAnecdote('${anecdote.id}')" class="text-red-600 hover:text-red-900">Eliminar</button>
                            </td>
                        </tr>
                    `).join('')
                    : `<tr><td colspan="3" class="px-6 py-4 text-center text-gray-500">No hay notas.</td></tr>`;

                return `
                    <div class="bg-gray-100 p-4 rounded-lg mb-4">
                        <h4 class="font-bold text-lg mb-2">${student.name}</h4>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nota</th>
                                        <th scope="col" class="relative px-6 py-3"><span class="sr-only">Acciones</span></th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    ${anecdoteRows}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('calificaciones').innerHTML = `
                <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
                    <h2 class="text-2xl font-bold mb-4">Calificaciones y Notas Anécdoticas</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h3 class="text-xl font-bold mb-2">Añadir Calificación</h3>
                            <div class="mb-4">
                                <label for="student-grade-select" class="block text-gray-700 font-bold mb-2">Estudiante</label>
                                <select id="student-grade-select" class="shadow border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                                    <option value="">Selecciona un estudiante</option>
                                    ${students.map(s => `<option value="${s.id}">${s.name}</option>`).join('')}
                                </select>
                            </div>
                            <div class="mb-4">
                                <label for="period-select" class="block text-gray-700 font-bold mb-2">Periodo</label>
                                <select id="period-select" class="shadow border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                                    <option value="P1">P1</option>
                                    <option value="P2">P2</option>
                                    <option value="P3">P3</option>
                                    <option value="P4">P4</option>
                                    <option value="RP">RP</option>
                                </select>
                            </div>
                            <div class="mb-4">
                                <label for="grade-input" class="block text-gray-700 font-bold mb-2">Calificación (0-100)</label>
                                <input type="number" id="grade-input" min="0" max="100" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                            </div>
                            <div class="mb-4">
                                <label for="grade-reason-select" class="block text-gray-700 font-bold mb-2">Motivo</label>
                                <select id="grade-reason-select" class="shadow border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                                    <option value="">Selecciona un motivo</option>
                                    <option value="Evaluación continua">Evaluación continua</option>
                                    <option value="Examen">Examen</option>
                                    <option value="Trabajo en clase">Trabajo en clase</option>
                                    <option value="Tarea">Tarea</option>
                                    <option value="Participación">Participación</option>
                                </select>
                            </div>
                            <div class="mb-4">
                                <label for="grade-note-input" class="block text-gray-700 font-bold mb-2">Nota</label>
                                <textarea id="grade-note-input" rows="2" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"></textarea>
                            </div>
                            <button onclick="addGrade()" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">Guardar Calificación</button>
                        </div>

                        <div>
                            <h3 class="text-xl font-bold mb-2">Añadir Nota Anécdotica</h3>
                            <div class="mb-4">
                                <label for="student-anecdote-select" class="block text-gray-700 font-bold mb-2">Estudiante</label>
                                <select id="student-anecdote-select" class="shadow border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                                    <option value="">Selecciona un estudiante</option>
                                    ${students.map(s => `<option value="${s.id}">${s.name}</option>`).join('')}
                                </select>
                            </div>
                            <div class="mb-4">
                                <label for="anecdote-date-input" class="block text-gray-700 font-bold mb-2">Fecha</label>
                                <input type="date" id="anecdote-date-input" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                            </div>
                            <div class="mb-4">
                                <label for="anecdote-note-input" class="block text-gray-700 font-bold mb-2">Nota</label>
                                <textarea id="anecdote-note-input" rows="5" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"></textarea>
                            </div>
                            <button onclick="addAnecdote()" class="bg-yellow-500 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">Guardar Nota</button>
                        </div>
                    </div>
                    <div class="mt-8">
                        <h3 class="text-xl font-bold mb-4">Historial de Calificaciones</h3>
                        ${gradesHtml}
                    </div>
                    <div class="mt-8">
                        <h3 class="text-xl font-bold mb-4">Historial de Notas Anécdoticas</h3>
                        ${anecdotesHtml}
                    </div>
                </div>
            `;
            
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('anecdote-date-input').value = today;
            document.getElementById('student-grade-select').addEventListener('change', updateUI);
            document.getElementById('student-anecdote-select').addEventListener('change', updateUI);
        }

        function renderStatistics() {
            const statsContent = document.getElementById('stats-content');
            if (students.length === 0) {
                statsContent.innerHTML = `<p class="text-gray-500">No hay estudiantes para generar estadísticas.</p>`;
                return;
            }

            const gradesByStudent = students.map(student => {
                const studentGrades = grades.filter(g => g.studentId === student.id);
                const average = studentGrades.length > 0
                    ? (studentGrades.reduce((sum, g) => sum + g.grade, 0) / studentGrades.length).toFixed(2)
                    : 'N/A';
                return { name: student.name, average, grades: studentGrades };
            });

            const statsHtml = `
                <div class="mb-6">
                    <h3 class="text-xl font-bold mb-2">Promedios por Estudiante</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        ${gradesByStudent.map(s => `
                            <div class="bg-gray-100 p-4 rounded-lg shadow-sm">
                                <h4 class="font-bold">${s.name}</h4>
                                <p>Promedio: <span class="font-bold">${s.average}</span></p>
                            </div>
                        `).join('')}
                    </div>
                </div>

                <div class="mb-6">
                    <h3 class="text-xl font-bold mb-2">Estadísticas por Periodo</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        ${['P1', 'P2', 'P3', 'P4', 'RP'].map(period => {
                            const periodGrades = grades.filter(g => g.period === period);
                            const periodAverage = periodGrades.length > 0
                                ? (periodGrades.reduce((sum, g) => sum + g.grade, 0) / periodGrades.length).toFixed(2)
                                : 'N/A';
                            return `
                                <div class="bg-gray-100 p-4 rounded-lg shadow-sm">
                                    <h4 class="font-bold">Periodo ${period}</h4>
                                    <p>Promedio: <span class="font-bold">${periodAverage}</span></p>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>

                <div class="mb-6">
                    <h3 class="text-xl font-bold mb-2">Gráfico de Calificaciones</h3>
                    <canvas id="gradesChart" class="bg-gray-100 p-4 rounded-lg shadow-sm"></canvas>
                </div>
            `;
            statsContent.innerHTML = statsHtml;
            
            const gradesChartCtx = document.getElementById('gradesChart').getContext('2d');
            const studentLabels = students.map(s => s.name);
            const studentAverages = gradesByStudent.map(s => s.average === 'N/A' ? 0 : parseFloat(s.average));
            new Chart(gradesChartCtx, {
                type: 'bar',
                data: {
                    labels: studentLabels,
                    datasets: [{
                        label: 'Promedio General',
                        data: studentAverages,
                        backgroundColor: 'rgba(59, 130, 246, 0.5)',
                        borderColor: 'rgba(59, 130, 246, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });
        }
        
        // --- FUNCIONES CRUD DE FIREBASE ---
        window.addGroup = async function() {
            const groupNameInput = document.getElementById('new-group-name');
            const groupName = groupNameInput.value.trim();
            const errorEl = document.getElementById('group-error');

            if (!groupName) {
                errorEl.textContent = 'El nombre del grupo no puede estar vacío.';
                errorEl.classList.remove('hidden');
                return;
            }
            errorEl.classList.add('hidden');

            try {
                await addDoc(collection(db, 'artifacts', appId, 'users', userId, 'groups'), {
                    name: groupName,
                    createdAt: new Date()
                });
                groupNameInput.value = '';
                showModal("Grupo Creado", `El grupo "${groupName}" ha sido creado con éxito.`);
            } catch (error) {
                console.error("Error adding group:", error);
                showModal("Error", "No se pudo crear el grupo.");
            }
        };

        window.deleteGroup = function(groupId, groupName) {
            showConfirmModal(`¿Estás seguro de que quieres eliminar el grupo "${groupName}"?`, async () => {
                const batch = writeBatch(db);
                try {
                    // Actualizar estudiantes en el grupo
                    const studentsInGroup = students.filter(s => s.groupId === groupId);
                    for (const student of studentsInGroup) {
                        const studentRef = doc(db, 'artifacts', appId, 'users', userId, 'students', student.id);
                        batch.update(studentRef, { groupId: '' });
                    }
                    
                    // Eliminar el grupo
                    const groupRef = doc(db, 'artifacts', appId, 'users', userId, 'groups', groupId);
                    batch.delete(groupRef);
                    
                    await batch.commit();
                    showModal("Grupo Eliminado", `El grupo "${groupName}" ha sido eliminado y los estudiantes han sido desvinculados.`);
                } catch (error) {
                    console.error("Error deleting group:", error);
                    showModal("Error", "No se pudo eliminar el grupo.");
                }
            });
        };

        window.addStudentsInBulk = async function() {
            const studentNamesInput = document.getElementById('student-names-input');
            const studentNames = studentNamesInput.value.split('\n').map(name => name.trim()).filter(name => name.length > 0);
            const groupId = document.getElementById('student-group-select').value;
            const errorEl = document.getElementById('student-error');

            if (studentNames.length === 0) {
                errorEl.textContent = 'Por favor, ingresa al menos un nombre de estudiante.';
                errorEl.classList.remove('hidden');
                return;
            }
            if (!groupId) {
                errorEl.textContent = 'Debes seleccionar un grupo.';
                errorEl.classList.remove('hidden');
                return;
            }
            errorEl.classList.add('hidden');

            const batch = writeBatch(db);
            const studentCollectionRef = collection(db, 'artifacts', appId, 'users', userId, 'students');
            const existingStudentNames = students.map(s => s.name.toLowerCase());
            const newStudentsToAdd = [];
            const duplicateStudents = [];

            studentNames.forEach(name => {
                if (existingStudentNames.includes(name.toLowerCase())) {
                    duplicateStudents.push(name);
                } else {
                    newStudentsToAdd.push({ name: name, groupId: groupId || '', createdAt: new Date() });
                }
            });

            if (duplicateStudents.length > 0) {
                errorEl.textContent = `Los siguientes estudiantes ya existen: ${duplicateStudents.join(', ')}.`;
                errorEl.classList.remove('hidden');
                return;
            }

            try {
                newStudentsToAdd.forEach(student => {
                    const newDocRef = doc(studentCollectionRef);
                    batch.set(newDocRef, student);
                });
                await batch.commit();
                studentNamesInput.value = '';
                document.getElementById('student-group-select').value = '';
                showModal("Estudiantes Añadidos", `Se han añadido ${newStudentsToAdd.length} estudiantes.`);
            } catch (error) {
                console.error("Error adding students in bulk:", error);
                showModal("Error", "No se pudo añadir los estudiantes.");
            }
        };

        window.deleteStudent = function(studentId, studentName) {
            showConfirmModal(`¿Estás seguro de que quieres eliminar a "${studentName}"?`, async () => {
                try {
                    await deleteDoc(doc(db, 'artifacts', appId, 'users', userId, 'students', studentId));
                    showModal("Estudiante Eliminado", `El estudiante "${studentName}" ha sido eliminado.`);
                } catch (error) {
                    console.error("Error deleting student:", error);
                    showModal("Error", "No se pudo eliminar el estudiante.");
                }
            });
        };

        window.saveAttendance = async function() {
            const date = document.getElementById('attendance-date').value;
            if (!date) {
                showModal("Error", "Por favor, selecciona una fecha.");
                return;
            }

            const records = {};
            const studentCheckboxes = document.querySelectorAll('#attendance-list input[type="checkbox"]');
            studentCheckboxes.forEach(checkbox => {
                records[checkbox.id] = checkbox.checked;
            });

            try {
                const attendanceRef = doc(db, 'artifacts', appId, 'users', userId, 'attendance', date);
                await setDoc(attendanceRef, { records: records }, { merge: true });
                showModal("Asistencia Guardada", `La asistencia para el ${date} ha sido guardada.`);
            } catch (error) {
                console.error("Error saving attendance:", error);
                showModal("Error", "No se pudo guardar la asistencia.");
            }
        };

        window.addGrade = async function() {
            const studentId = document.getElementById('student-grade-select').value;
            const period = document.getElementById('period-select').value;
            const gradeValue = document.getElementById('grade-input').value;
            const reason = document.getElementById('grade-reason-select').value;
            const note = document.getElementById('grade-note-input').value.trim();

            if (!studentId || !period || gradeValue === '' || gradeValue < 0 || gradeValue > 100) {
                showModal("Error", "Por favor, completa todos los campos de calificación correctamente.");
                return;
            }

            try {
                await addDoc(collection(db, 'artifacts', appId, 'users', userId, 'grades'), {
                    studentId,
                    period,
                    grade: parseInt(gradeValue),
                    reason,
                    note,
                    date: new Date().toISOString().split('T')[0],
                    createdAt: new Date()
                });
                showModal("Calificación Guardada", `La calificación ha sido guardada con éxito.`);
                document.getElementById('grade-input').value = '';
                document.getElementById('grade-reason-select').value = '';
                document.getElementById('grade-note-input').value = '';
            } catch (error) {
                console.error("Error adding grade:", error);
                showModal("Error", "No se pudo guardar la calificación.");
            }
        };

        window.editGrade = function(gradeId) {
            const grade = grades.find(g => g.id === gradeId);
            if (grade) {
                document.getElementById('edit-grade-id').value = grade.id;
                document.getElementById('edit-grade-input').value = grade.grade;
                document.getElementById('edit-grade-reason-select').value = grade.reason;
                document.getElementById('edit-grade-note-input').value = grade.note;
                document.getElementById('edit-grade-modal').classList.remove('hidden');
            }
        };

        window.saveEditedGrade = async function() {
            const gradeId = document.getElementById('edit-grade-id').value;
            const newGradeValue = document.getElementById('edit-grade-input').value;
            const newReason = document.getElementById('edit-grade-reason-select').value;
            const newNote = document.getElementById('edit-grade-note-input').value.trim();

            if (newGradeValue === '' || newGradeValue < 0 || newGradeValue > 100) {
                showModal("Error", "La calificación no es válida.");
                return;
            }
            
            document.getElementById('edit-grade-modal').classList.add('hidden');
            
            try {
                await updateDoc(doc(db, 'artifacts', appId, 'users', userId, 'grades', gradeId), {
                    grade: parseInt(newGradeValue),
                    reason: newReason,
                    note: newNote
                });
                showModal("Calificación Actualizada", "La calificación ha sido actualizada.");
            } catch (error) {
                console.error("Error updating grade:", error);
                showModal("Error", "No se pudo actualizar la calificación.");
            }
        };

        window.deleteGrade = function(gradeId) {
            showConfirmModal("¿Estás seguro de que quieres eliminar esta calificación?", async () => {
                try {
                    await deleteDoc(doc(db, 'artifacts', appId, 'users', userId, 'grades', gradeId));
                    showModal("Calificación Eliminada", "La calificación ha sido eliminada.");
                } catch (error) {
                    console.error("Error deleting grade:", error);
                    showModal("Error", "No se pudo eliminar la calificación.");
                }
            });
        };

        window.addAnecdote = async function() {
            const studentId = document.getElementById('student-anecdote-select').value;
            const date = document.getElementById('anecdote-date-input').value;
            const note = document.getElementById('anecdote-note-input').value.trim();

            if (!studentId || !date || !note) {
                showModal("Error", "Por favor, completa todos los campos.");
                return;
            }

            try {
                await addDoc(collection(db, 'artifacts', appId, 'users', userId, 'anecdotes'), {
                    studentId,
                    date,
                    note,
                    createdAt: new Date()
                });
                showModal("Nota Guardada", "La nota anecdótica ha sido guardada con éxito.");
                document.getElementById('anecdote-note-input').value = '';
            } catch (error) {
                console.error("Error adding anecdote:", error);
                showModal("Error", "No se pudo guardar la nota.");
            }
        };

        window.editAnecdote = function(anecdoteId) {
            const anecdote = anecdotes.find(a => a.id === anecdoteId);
            if (anecdote) {
                document.getElementById('edit-anecdote-id').value = anecdote.id;
                document.getElementById('edit-anecdote-note-input').value = anecdote.note;
                document.getElementById('edit-anecdote-modal').classList.remove('hidden');
            }
        };

        window.saveEditedAnecdote = async function() {
            const anecdoteId = document.getElementById('edit-anecdote-id').value;
            const newNote = document.getElementById('edit-anecdote-note-input').value.trim();

            if (!newNote) {
                showModal("Error", "La nota no puede estar vacía.");
                return;
            }

            document.getElementById('edit-anecdote-modal').classList.add('hidden');
            try {
                await updateDoc(doc(db, 'artifacts', appId, 'users', userId, 'anecdotes', anecdoteId), {
                    note: newNote
                });
                showModal("Nota Actualizada", "La nota anecdótica ha sido actualizada con éxito.");
            } catch (error) {
                console.error("Error updating anecdote:", error);
                showModal("Error", "No se pudo actualizar la nota.");
            }
        };

        window.deleteAnecdote = function(anecdoteId) {
            showConfirmModal("¿Estás seguro de que quieres eliminar esta nota?", async () => {
                try {
                    await deleteDoc(doc(db, 'artifacts', appId, 'users', userId, 'anecdotes', anecdoteId));
                    showModal("Nota Eliminada", "La nota anecdótica ha sido eliminada con éxito.");
                } catch (error) {
                console.error("Error deleting anecdote:", error);
                showModal("Error", "No se pudo eliminar la nota.");
                }
            });
        };

        // --- RENDERIZADO INICIAL ---
        document.addEventListener('DOMContentLoaded', () => {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('attendance-date').value = today;
            document.getElementById('anecdote-date-input').value = today;
            initializeFirebase();
            updateUI();
            activateTab('gestion');
        });
    </script>
</body>
</html>